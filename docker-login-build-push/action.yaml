name: Docker login, build & push action
description: Docker composite that does the login into Google AR, builds and pushes the docker image to AR

inputs:
  image:
    required: true
    description: Docker image name

  context:
    required: true
    default: "."
    description: Docker build context

  dockerfile:
    required: true
    default: "Dockerfile"
    description: Dockerfile name & path

  args:
    required: true
    default: ""
    description: Docker args

  google-region:
    required: true
    description: Google Project Region

  google-credentials:
    required: true
    description: Google Credentials for AR access

  scan_image:
    required: true
    default: 'true'
    description: Scan the builded image before push
  
  scan_output_format:
    description: Trivy output format
    required: true
    default: "table"
  
  scan_fail_build:
    description: Fail build if vulnerabilities are found
    required: true
    default: "true"

  scan_severity_cutoff:
    description: Severity cutoff (UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL)
    required: true
    default: "HIGH"

  scan_vuln_type:
    description: Vulnerability types to scan for (os,library)
    required: true
    default: "os,library"

  scan_license:
    description: Enable license scanning
    required: true
    default: "true"

  push:
    required: true
    default: "true"
    description: Docker push

outputs:
  image:
    description: Image built by this action
    value: ${{ inputs.image }}

runs:
  using: composite
  steps:
    - name: Docker Login to GCP Artifact Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ inputs.google-region }}-docker.pkg.dev
        username: _json_key
        password: ${{ inputs.google-credentials }}

    - name: Docker Build
      id: docker-build
      shell: bash
      run: docker build ${{ inputs.args }} -t '${{ inputs.image }}' -f ${{ inputs.dockerfile }} ${{ inputs.context }}

    - name: Trivy vulnerability scanner
      id: scan-image-vuln
      if: ${{ inputs.scan_image == 'true' }}
      uses: aquasecurity/trivy-action@v0.30.0
      with:
        scan-type: image
        image-ref: ${{ inputs.image }}
        format: ${{ inputs.scan_output_format }}
        exit-code: ${{ inputs.scan_fail_build == 'true' && '1' || '0' }}
        severity: ${{ inputs.scan_severity_cutoff }}
        vuln-type: ${{ inputs.scan_vuln_type }}

    - name: Trivy license scanner
      id: scan-fs-license
      if: ${{ inputs.scan_image == 'true' && inputs.scan_license == 'true' }}
      uses: aquasecurity/trivy-action@v0.30.0
      with:
        scan-type: fs
        scan-ref: .
        scanners: license
        format: ${{ inputs.scan_output_format }}
        exit-code: ${{ inputs.scan_fail_build == 'true' && '1' || '0' }}
    
    - name: Docker Push
      id: docker-push
      if: ${{ inputs.push == 'true' }}
      shell: bash
      run: docker push '${{ inputs.image }}'
